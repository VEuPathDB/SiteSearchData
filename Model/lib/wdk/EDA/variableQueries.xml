<wdkModel>

  <querySet name="VariableIdQueries" queryType="id" isCacheable="true">
    <sqlQuery name="AllVariables">
      <column name="variable_id"/>
      <sql>
        <![CDATA[
          select distinct stable_id as variable_id
          from eda.AttributeGraph
          where (hidden is null
                 or (hidden != '["everywhere"]'
                     and hidden != '["variableTree"]'))
            and stable_id
                in (select stable_id
                    from eda.Attribute)
            and study_id
                not in (select s.study_id
                        from apidbTuning.StudyIdDatasetId sidi, eda.Study s
                        where s.stable_id = sidi.study_stable_id
                          and sidi.dataset_id
                              in (  select dataset_presenter_id
                                    from apidbTuning.DatasetProperty
                                    where property = 'isPublic'
                                      and value = 'false'
                                  union
                                    select dataset_presenter_id
                                    from apidbTuning.DatasetProperty
                                    where property = 'studyAccess'
                                      and value in ('private', 'prerelease')
                                 )
                       )
            and study_id
                in (select s.study_id
                    from apidbTuning.StudyIdDatasetId sidi, eda.Study s
                    where s.stable_id = sidi.study_stable_id
                      and sidi.dataset_id
                          in (select dataset_presenter_id
                              from apidbTuning.DatasetDatasource
                              where project_id = '@PROJECT_ID@'
                             )
                   )
        ]]>
      </sql>
    </sqlQuery>
  </querySet>

  <querySet name="VariableAttributes" queryType="attribute" isCacheable="false">

    <sqlQuery name="Name">
      <column name="variable_id"/>
      <column name="name"/>
      <column name="project"/>
      <column name="hyperlinkName"/>
      <sql>
        <![CDATA[
          select attribute_id as variable_id,
                 string_agg(display_name, ' / ' order by display_name)
                   as name,
                 '@PROJECT_ID@' as project,
                 string_agg(display_name, ' / ' order by display_name)
                   as hyperlinkName
          from (select distinct stable_id as attribute_id, display_name
                from eda.AttributeGraph
                where (hidden is null
                       or (hidden != '["everywhere"]'
                           and hidden != '["variableTree"]'))
                  and stable_id
                      in (select stable_id
                          from eda.Attribute)
                  and study_id
                      not in (select s.study_id
                              from apidbTuning.StudyIdDatasetId sidi, eda.Study s
                              where s.stable_id = sidi.study_stable_id
                                and sidi.dataset_id
                                    in (  select dataset_presenter_id
                                          from apidbTuning.DatasetProperty
                                          where property = 'isPublic'
                                            and value = 'false'
                                        union
                                          select dataset_presenter_id
                                          from apidbTuning.DatasetProperty
                                          where property = 'studyAccess'
                                            and value in ('private', 'prerelease')
                                       )
                             )
                  and study_id
                      in (select s.study_id
                          from apidbTuning.StudyIdDatasetId sidi, eda.Study s
                          where s.stable_id = sidi.study_stable_id
                            and sidi.dataset_id
                                in (select dataset_presenter_id
                                    from apidbTuning.DatasetDatasource
                                    where project_id = '@PROJECT_ID@'
                                   )
                         )
               )
          group by attribute_id
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="CategoriesPath">
      <column name="variable_id"/>
      <column name="path"/>
      <sql>
        <![CDATA[
WITH RECURSIVE attr_tree AS (

    -- Anchor: root attributes (Oracle: START WITH stable_id IN (SELECT stable_id FROM eda.Attribute))
    SELECT
        ag.stable_id,
        ag.parent_stable_id,
        ag.study_id,
        ag.display_name AS ancestor,
        ag.stable_id AS attribute_id,     
        1 AS lvl
    FROM eda.AttributeGraph ag
    WHERE ag.stable_id IN (SELECT stable_id FROM eda.Attribute)
      AND (ag.hidden IS NULL
           OR (ag.hidden != '["everywhere"]'
               AND ag.hidden != '["variableTree"]'))
      AND ag.study_id NOT IN (
            SELECT s.study_id
            FROM apidbTuning.StudyIdDatasetId sidi
            JOIN eda.Study s ON s.stable_id = sidi.study_stable_id
            WHERE sidi.dataset_id IN (
                SELECT dataset_presenter_id
                FROM apidbTuning.DatasetProperty
                WHERE (property = 'isPublic' AND value = 'false')
                   OR (property = 'studyAccess' AND value IN ('private','prerelease'))
            )
      )
      AND ag.study_id IN (
            SELECT s.study_id
            FROM apidbTuning.StudyIdDatasetId sidi
            JOIN eda.Study s ON s.stable_id = sidi.study_stable_id
            WHERE sidi.dataset_id IN (
                SELECT dataset_presenter_id
                FROM apidbTuning.DatasetDatasource
                WHERE project_id = '@PROJECT_ID@'
            )
      )
      AND ag.stable_id NOT IN (SELECT stable_id FROM eda.EntityTypeGraph)

    UNION ALL

    -- Recursive step 
    SELECT
        child.stable_id,
        child.parent_stable_id,
        child.study_id,
        child.display_name AS ancestor,
        root.attribute_id,
        root.lvl + 1
    FROM eda.AttributeGraph child
    JOIN attr_tree root
      ON child.parent_stable_id = root.stable_id
     AND child.study_id = root.study_id
    WHERE (child.hidden IS NULL
           OR (child.hidden != '["everywhere"]'
               AND child.hidden != '["variableTree"]'))
      AND child.stable_id NOT IN (SELECT stable_id FROM eda.EntityTypeGraph)
)

-- Build paths 
, paths AS (
    SELECT
        attribute_id,
        study_id,
        string_agg(ancestor, ' > ' ORDER BY lvl DESC) AS path
    FROM attr_tree
    GROUP BY attribute_id, study_id
)

, trimmed AS (
    SELECT DISTINCT
        attribute_id,
        regexp_replace(path, ' >[^>]*$', '') AS path
    FROM paths
)

SELECT
    attribute_id AS variable_id,
    COALESCE(string_agg(path, '; ' ORDER BY path), 'n/a') AS path
FROM trimmed
GROUP BY attribute_id
         ]]>
      </sql>
    </sqlQuery>

  </querySet>

  <querySet name="VariableTables" queryType="table" isCacheable="false">

    <sqlQuery name="StudyInfo">
      <column name="variable_id"/>
      <column name="dataset_id"/>
      <column name="study_id"/>
      <column name="study_name"/>
      <column name="entity_type_id"/>
      <column name="entity_type"/>
      <column name="provider_label"/>
      <column name="attribute_definition"/>
      <sql>
        <![CDATA[
          select distinct sd.dataset_id, sd.study_stable_id as study_id,
                          ag.stable_id as variable_id,
                          a.entity_type_stable_id as entity_type_id,
                          coalesce(ag.display_name, 'n/a') as attribute_name,
                          coalesce(ag.provider_label, 'n/a') as provider_label,
                          coalesce(dsp.display_name, 'n/a') as study_name,
                          coalesce(etg.display_name, 'n/a') as entity_type,
                          coalesce(ag.definition, 'n/a') as attribute_definition
          from eda.AttributeGraph ag, eda.Attribute a, eda.EntityTypeGraph etg,
               apidbTuning.StudyIdDatasetId sd, eda.Study s,
               apidbTuning.DatasetPresenter dsp, apidbtuing.datasetdatasource dd
          where ag.stable_id = a.stable_id
            and a.entity_type_id = etg.entity_type_id
            and etg.study_stable_id = sd.study_stable_id
            and ag.study_id = s.study_id
            and s.stable_id = etg.study_stable_id
            and sd.dataset_id = dsp.dataset_presenter_id
            and dd.dataset_presenter_id = dsp.dataset_presenter_id
            and dd.project_id = '@PROJECT_ID@'
            and (ag.hidden is null
                 or (ag.hidden != '["everywhere"]'
                     and ag.hidden != '["variableTree"]'))
            and ag.study_id
                not in (select s.study_id
                        from apidbTuning.StudyIdDatasetId sidi, eda.Study s
                        where s.stable_id = sidi.study_stable_id
                          and sidi.dataset_id
                              in (  select dataset_presenter_id
                                    from apidbTuning.DatasetProperty
                                    where property = 'isPublic'
                                      and value = 'false'
                                  union
                                    select dataset_presenter_id
                                    from apidbTuning.DatasetProperty
                                    where property = 'studyAccess'
                                      and value in ('private', 'prerelease')
                                 )
                       )
          order by dsp.display_name, etg.display_name
        ]]>
      </sql>
    </sqlQuery>

  </querySet>

</wdkModel>
