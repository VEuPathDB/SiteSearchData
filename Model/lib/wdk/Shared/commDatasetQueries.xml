<wdkModel>

  <querySet name="CommunityDatasetIdQueries" queryType="id" isCacheable="false">

    <processQuery name="AllCommunityDatasets"
        processName="org.eupathdb.sitesearch.wsfplugin.CommunityStudyIdsPlugin">
      <paramRef ref="datasetParams.projectId"/>  <!-- included just to avoid cache hits -->
      <wsColumn name="dataset_id" width="50" wsName="dataset_id"/>
      <wsColumn name="owner_name" width="100" wsName="owner_name"/>
      <wsColumn name="owner_institution" width="200" wsName="owner_institution"/>
    </processQuery>
  </querySet>

  <querySet name="CommunityDatasetAttributes" queryType="attribute" isCacheable="false">
    <sqlQuery name="All">
      <column name="hyperlinkName"/>
      <column name="dataset_id"/>
      <column name="display_name"/>
      <column name="project"/>
      <column name="description"/>
      <column name="summary"/>
      <sql>
        <![CDATA[
          select user_dataset_id as dataset_id, project_id as project,
                 name, name as display_name, name as hyperlinkName, description, summary
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets
          where project_id = '@PROJECT_ID@'
          and is_public = true and is_owner = 1            
        ]]>
      </sql>
    </sqlQuery>

  </querySet>

  <querySet name="CommunityDatasetTables" queryType="table" isCacheable="false">
    <sqlQuery name="publications">
      <column name="dataset_id"/>
      <column name="pubmed_id"/>
      <column name="citation"/>
      <sql>
        <![CDATA[
          select aud.user_dataset_id as dataset_id, pubmed_id, citation
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets aud,
	  @VDI_CONTROL_SCHEMA@dataset_publication dp	 
          where aud.project_id = '@PROJECT_ID@'
          and aud.is_public = true and aud.is_owner = 1
          and aud.dataset_id = dp.dataset_id
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="hyperlinks">
      <column name="dataset_id"/>
      <column name="text"/>
      <column name="description"/>
      <sql>
        <![CDATA[
          select aud.user_dataset_id as dataset_id, text, description
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets aud,
	  @VDI_CONTROL_SCHEMA@dataset_hyperlinks dh	 
          where aud.project_id = '@PROJECT_ID@'
          and aud.is_public = true and aud.is_owner = 1
          and aud.dataset_id = dh.dataset_id
        ]]>
      </sql>
    </sqlQuery>
    
    <sqlQuery name="organisms">
      <column name="dataset_id"/>
      <column name="organism_name"/>
      <sql>
        <![CDATA[
          select aud.user_dataset_id as dataset_id,
	  species || ' ' || strain as organism_name
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets aud,
	  @VDI_CONTROL_SCHEMA@dataset_organism do, apidbtuning.organismAttributes oa	 
          where aud.project_id = '@PROJECT_ID@'
          and aud.is_public = true and aud.is_owner = 1
          and aud.dataset_id = do.dataset_id
	  and do.organism_abbrev = oa.internal_abbrev
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="contacts">
      <column name="dataset_id"/>
      <column name="contact_name"/>
      <column name="affiliation"/>
      <sql>
        <![CDATA[
          select aud.user_dataset_id as dataset_id,
          concat(dc.first_name, ' ', dc.middle_name, ' ', dc.last_name) as contact_name, affiliation
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets aud,
	  @VDI_CONTROL_SCHEMA@dataset_contact dc
          where aud.project_id = '@PROJECT_ID@'
          and aud.is_public = true and aud.is_owner = 1
          and aud.dataset_id = dc.dataset_id
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="countries">
      <column name="dataset_id"/>
      <column name="country"/>
      <sql>
        <![CDATA[
          select aud.user_dataset_id as dataset_id, country
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets aud,
	  @VDI_CONTROL_SCHEMA@dataset_country dc
          where aud.project_id = '@PROJECT_ID@'
          and aud.is_public = true and aud.is_owner = 1
          and aud.dataset_id = dc.dataset_id
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="species">
      <column name="dataset_id"/>
      <column name="species"/>
      <sql>
        <![CDATA[
          select aud.user_dataset_id as dataset_id, species
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets aud,
	  @VDI_CONTROL_SCHEMA@dataset_species ds
          where aud.project_id = '@PROJECT_ID@'
          and aud.is_public = true and aud.is_owner = 1
          and aud.dataset_id = ds.dataset_id
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="diseases">
      <column name="dataset_id"/>
      <column name="disease"/>
      <sql>
        <![CDATA[
          select aud.user_dataset_id as dataset_id, disease
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets aud,
	  @VDI_CONTROL_SCHEMA@dataset_disease dd
          where aud.project_id = '@PROJECT_ID@'
          and aud.is_public = true and aud.is_owner = 1
          and aud.dataset_id = dd.dataset_id
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="associatedFactors">
      <column name="dataset_id"/>
      <column name="factor"/>
      <sql>
        <![CDATA[
          select aud.user_dataset_id as dataset_id, factor
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets aud,
	  @VDI_CONTROL_SCHEMA@dataset_associated_factor daf
          where aud.project_id = '@PROJECT_ID@'
          and aud.is_public = true and aud.is_owner = 1
          and aud.dataset_id = daf.dataset_id
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="dois">
      <column name="dataset_id"/>
      <column name="doi"/>
      <column name="description"/>
      <sql>
        <![CDATA[
          select aud.user_dataset_id as dataset_id, doi, description
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets aud,
	  @VDI_CONTROL_SCHEMA@dataset_doi dd
          where aud.project_id = '@PROJECT_ID@'
          and aud.is_public = true and aud.is_owner = 1
          and aud.dataset_id = dd.dataset_id
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="bioprojectIds">
      <column name="dataset_id"/>
      <column name="bioproject_id"/>
      <column name="description"/>
      <sql>
        <![CDATA[
          select aud.user_dataset_id as dataset_id, bioproject_id, description
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets aud,
	  @VDI_CONTROL_SCHEMA@dataset_bioproject_id dbi
          where aud.project_id = '@PROJECT_ID@'
          and aud.is_public = true and aud.is_owner = 1
          and aud.dataset_id = dbi.dataset_id
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="fundingAwards">
      <column name="dataset_id"/>
      <column name="agency"/>
      <column name="award_number"/>
      <sql>
        <![CDATA[
          select aud.user_dataset_id as dataset_id, agency, award_number
          from @VDI_CONTROL_SCHEMA@AvailableUserDatasets aud,
	  @VDI_CONTROL_SCHEMA@dataset_funding_award dfa
          where aud.project_id = '@PROJECT_ID@'
          and aud.is_public = true and aud.is_owner = 1
          and aud.dataset_id = dfa.dataset_id
        ]]>
      </sql>
    </sqlQuery>


  </querySet>

</wdkModel>
