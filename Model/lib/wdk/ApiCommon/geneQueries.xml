<wdkModel>

  <querySet name="GeneIdQueries" queryType="id" isCacheable="true">
    <sqlQuery name="GenesByOrganismAbbrev">
      <paramRef ref="geneParams.organismAbbrev"/>
      <column name="source_id"/>
      <sql>
        <![CDATA[
          select distinct ga.source_id
          from apidbTuning.GeneAttributes ga, apidb.Organism o
          where ga.taxon_id = o.taxon_id
            and o.abbrev = $$organismAbbrev$$
        ]]>
      </sql>
    </sqlQuery>
  </querySet>

  <paramSet name="geneParams">
    <flatVocabParam name="organismAbbrev"
                    queryRef="GeneParamQueries.organismAbbrevs"
                    multiPick="false"
                    prompt="OrganismAbbrev"
                    quote="true">
    </flatVocabParam>
  </paramSet>

  <querySet name="GeneParamQueries" queryType="vocab"  isCacheable="false">
    <sqlQuery name="organismAbbrevs">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
          select distinct o.abbrev AS internal, o.abbrev AS term
          from apidb.Organism o
        ]]>
      </sql>
    </sqlQuery>

  </querySet>


  <querySet name="GeneAttributes" queryType="attribute" isCacheable="false">
    <!-- Used by WDK to replace %%PARTITION_KEYS%% macro with the keys for a result set -->
    <sqlQuery name="PartitionKeys">
      <column name="source_id"/>
      <column name="partition_id"/>
      <sql>
        <![CDATA[
         select source_id, org_abbrev as partition_key from apidbtuning.GeneOrgAbbrev
        ]]>
      </sql>  
    </sqlQuery>

    <sqlQuery name="GeneAlias">
      <column name="source_id"/>
      <column name="old_source_id"/>
      <sql>
        <![CDATA[
          select a.gene AS source_id, a.id as old_source_id
          from webready.GeneId_p a
          where a.unique_mapping = 1
            and a.org_abbrev IN (%%PARTITION_KEYS%%)
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="Bfmv">
      <column name="source_id"/>
      <column name="product"/>
      <column name="name"/>
      <column name="gene_type"/>
      <column name="sequence_id"/>
      <column name="organism_full"/>
      <column name="organism"/>
      <column name="orthomcl_name"/>
      <column name="so_id"/>
      <column name="so_term_name"/>
      <column name="projectAux"/> <!-- needed for Apollo Site Search Updater -->
      <sql>
        <![CDATA[
          select source_id, product, name, gene_type,
                 sequence_id, organism as organism_full, organism,
                 group_id as orthomcl_name, so_id, so_term_name,
                 '@PROJECT_ID@' as projectAux
          from webready.GeneAttributes_p ga 
          left join webready.geneorthologgroup g ON ga.source_id = g.gene_id
          where ga.org_abbrev IN (%%PARTITION_KEYS%%)
        ]]>
      </sql>
    </sqlQuery>

  </querySet>

  <querySet name="GeneTables" queryType="table" isCacheable="false">

    <sqlQuery name="UserCommentIDs">
      <column name="source_id"/>
      <column name="comment_id"/>
      <sql>
        <![CDATA[
          select tsc.source_id, tsc.comment_id
          from apidb.TextSearchableComment@COMMENT_DBLINK@ tsc,
               @COMMENT_SCHEMA@MappedComment@COMMENT_DBLINK@ mc
          where mc.comment_id = tsc.comment_id
            and tsc.comment_target_type = 'gene'
            and mc.review_status_id != 'rejected'
            and mc.is_visible = 1
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="UserCommentContent">
      <column name="source_id"/>
      <column name="content"/>
      <sql>
        <![CDATA[
          select tsc.source_id, tsc.content
          from apidb.textsearchablecomment@COMMENT_DBLINK@ tsc,
               @COMMENT_SCHEMA@mappedComment@COMMENT_DBLINK@ mc
          where mc.comment_id = tsc.comment_id
            and tsc.comment_target_type = 'gene'
            and mc.review_status_id != 'rejected'
            and mc.is_visible = 1
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="ApolloCommentIds">
      <column name="source_id"/>
      <column name="comment_id"/>
      <sql>
        <![CDATA[
          select distinct source_id, id_attr as comment_id from apidbtuning.ApolloUpdateGene
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="ApolloCommentContent">
      <column name="source_id"/>
      <column name="ApolloComment"/>
      <sql>
        <![CDATA[
          select source_id, attr as ApolloComment from apidbTuning.ApolloUpdateGene
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="ProteinSourceIDs">
      <column name="source_id"/>
      <column name="protein_source_id"/>
      <sql>
        <![CDATA[
          select ta.gene_source_id as source_id, ta.protein_source_id
          from webready.TranscriptAttributes_p ta
          where ta.org_abbrev IN (%%PARTITION_KEYS%%)
        ]]>
      </sql>
    </sqlQuery>


    <sqlQuery name="GeneTranscripts">
      <column name="source_id"/>
      <column name="transcript_id"/>
      <sql>
        <!-- transcripts must be ordered alphabetically, as expected by client -->
        <![CDATA[
          select gene_source_id as source_id, source_id as transcript_id
          from webready.TranscriptAttributes_p
          where org_abbrev IN (%%PARTITION_KEYS%%)
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="Organisms">
      <column name="source_id"/>
      <column name="organism"/>
      <sql>
        <![CDATA[
          select source_id, organism
          from webready.GeneAttributes_p
          where org_abbrev IN (%%PARTITION_KEYS%%)
        ]]>
      </sql>
    </sqlQuery>


    <sqlQuery name="ECNumbers" >
      <column name="source_id"/>
      <column name="ec_number"/>
      <column name="ec_description"/>
      <column name="ec_source"/>
      <column name="expasy_url"/>

      <sql>
        <![CDATA[
          select ta.gene_source_id AS source_id, ec.ec_number,
                 ec.description AS ec_description,
                 decode(asec.evidence_code,
                        'OrthoMCLDerived', 'computationally inferred from orthology',
                        'gb', 'GenBank',
                        'Hagai', 'MPMP',
                        evidence_code)
                   as ec_source,
                 'http://enzyme.expasy.org/cgi-bin/enzyme/enzyme-search-ec?field1='
                   || ec.ec_number_1
                   || decode(ec.ec_number_2,
                             null, null,
                             chr(38) || 'field2=' || ec.ec_number_2)
                   || decode(ec.ec_number_3,
                             null, null,
                             chr(38) || 'field3=' || ec.ec_number_3)
                   || decode(ec.ec_number_4,
                             null, null,
                             chr(38) || 'field4=' || ec.ec_number_4)
                   as expasy_url
          from webready.TranscriptAttributes_p ta, sres.enzymeclass ec,
               dots.AaSequenceEnzymeClass asec
          where ta.aa_sequence_id = asec.aa_sequence_id
            and asec.enzyme_class_id = ec.enzyme_class_id
            and ta.org_abbrev IN (%%PARTITION_KEYS%%)
          group by ta.gene_source_id, ec.ec_number, ec.description,
                   asec.evidence_code,
                   ec.ec_number_1, ec.ec_number_2, ec.ec_number_3, ec.ec_number_4
        ]]>
      </sql>
    </sqlQuery>

    <!--++++++++++-->
    <!-- GO terms -->
    <!--++++++++++-->

    <sqlQuery name="GOTerms" >
      <column name="source_id"/>
      <column name="go_id"/>
      <column name="go_term_name"/>
      <column name="reference"/>
      <sql>
        <![CDATA[
          SELECT source_id, go_id, go_term_name, reference
          FROM webready.GeneGoTable_p
          where org_abbrev IN (%%PARTITION_KEYS%%)
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="Orthologs">
      <column name="source_id"/>
      <column name="ortho_product"/>
      <column name="ortho_name"/>
      <sql>
        <![CDATA[
          select distinct source_id, ortho_product, ortho_name
          from apidbTuning.OrthologousTranscripts
        ]]>
      </sql>
    </sqlQuery>
    
    <sqlQuery name="InterPro">
      <column name="source_id"/>
      <column name="interpro_name"/>
      <column name="interpro_family_id"/>
      <column name="interpro_primary_id"/>
      <column name="interpro_secondary_id"/>
      <column name="interpro_desc"/>
      <sql>
        <![CDATA[
                 select ir.gene_source_id as source_id
                      , ir.interpro_db_name AS interpro_name
                      , ir.interpro_primary_id
                      , ir.interpro_secondary_id
                      , ir.interpro_desc
                      , ir.interpro_family_id
                 from Webready.interproresults_p ir
                 where ir.org_abbrev IN (%%PARTITION_KEYS%%)
                 group by ir.gene_source_id
                        , ir.interpro_db_name
                        , ir.interpro_primary_id
                        , ir.interpro_secondary_id
                        , ir.interpro_desc
                        , ir.interpro_family_id
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="Alias">
      <column name="source_id"/>
      <column name="alias"/>
      <column name="database_name"/>
      <column name="id_type"/>
      <sql>
        <![CDATA[
     with alias_query as (
          select distinct
                 upper(replace(gi.id, ';current=false', '')) as alias,
                 gi.database_name,
                 case
                   when gi.database_name like '%synonym%'
                     then 'synonym'
                   when gi.database_name like '%primary_genome%'
                     then 'name'
                   when gi.database_name like '%PreviousGeneIDs%'
                     then 'previous ID'
                   when gi.database_name like '%aliases%'
                     then 'alias'
                   else 'alternate ID'
                 end as id_type,
                 gi.gene AS source_id
          from webready.GeneId_p gi
          where regexp_like(gi.id, '(\D)')
            and gi.database_name not like '%gene2Uniprot_RSRC'
            and gi.org_abbrev IN (%%PARTITION_KEYS%%)
            -- and gi.union_member != 'same ID' 
         )
     select * from alias_query
     union
     select regexp_replace(alias, '(*)\.\d\d?$', '') as alias,
            database_name,'base name ' || id_type as id_type,source_id
     from alias_query
     where regexp_like(alias,'(*)\.\d\d?$')
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="Notes" clobRow="true">

      <column name="source_id"/>
      <column name="comment_string"/>
      <sql>
        <![CDATA[
          select nfc.comment_string, ci.source_id
          from dots.NaFeatureComment nfc,
               (select nfc.na_feature_comment_id,
                       ta.gene_source_id as source_id
                from dots.NaFeatureComment nfc, webready.TranscriptAttributes_p ta
                where (ta.na_feature_id = nfc.na_feature_id
                   or ta.gene_na_feature_id = nfc.na_feature_id)
                  and ta.org_abbrev IN (%%PARTITION_KEYS%%)
                group by nfc.na_feature_comment_id, ta.gene_source_id
               ) ci
          where ci.na_feature_comment_id = nfc.na_feature_comment_id
        ]]>
      </sql>
    </sqlQuery>


    <sqlQuery name="MetabolicPathways">

      <column name="source_id"/>
      <column name="pathway_source"/>
      <column name="pathway_source_id"/>
      <column name="pathway_name"/>

      <sql>
        <![CDATA[
            select gene_source_id AS source_id, pathway_source,
                   pathway_source_id, pathway_name
            from webready.PathwaysGeneTable_p
            where org_abbrev IN (%%PARTITION_KEYS%%)
        ]]>
      </sql>
    </sqlQuery>


    <sqlQuery name="Epitopes">

      <column name="source_id"/>
      <column name="transcript_id"/>
      <column name="iedb_id"/>
      <column name="sequence"/>
      <column name="name"/>
      <sql>
        <![CDATA[
          SELECT DISTINCT ae.iedb_id
	  , ta.source_id as transcript_id
	  , ta.gene_source_id as source_id
	  , mt.sequence
	  , ta.organism as name
          FROM    dots.motifaasequence mt
           	      , webready.aasequenceepitope_p ae 
		      , webready.TranscriptAttributes_p ta
          WHERE   ae.iedb_id = mt.source_id::integer and
		      ae.aa_sequence_id = ta.aa_sequence_id
            AND ta.org_abbrev IN (%%PARTITION_KEYS%%)
            AND ae.org_abbrev IN (%%PARTITION_KEYS%%)
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="Products" isCacheable="false" >
      <column name="source_id"/>
      <column name="product"/>
      <sql>
      <![CDATA[
          select source_id, product
          from apidbTuning.AllGeneProducts_p
	  where org_abbrev IN (%%PARTITION_KEYS%%)
      ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="gene_dbrefs">
      <column name="source_id"/>
      <column name="dataset"/>
      <column name="link_url"/>

      <sql>
        <![CDATA[
            select edd.dataset_presenter_display_name AS dataset, ga.source_id,
                   db.primary_identifier AS ext_id
            from sres.DbRef db, webready.DbRefNaFeature_p dbna,
                 apidbTuning.ExternalDbDatasetPresenter edd,
                 webready.GeneAttributes_p ga
            where db.external_database_release_id = edd.external_database_release_id
              and dbna.db_ref_id = db.db_ref_id
              and ga.na_feature_id = dbna.na_feature_id
              and lower(edd.dataset_presenter_name) not like '%nrdb%'
              and lower(edd.dataset_presenter_name) not like '%nafeature_aliases%'
              and edd.dataset_presenter_name not like '%dbxref_simple_gene2HagaiPathway%'
              and lower(edd.dataset_presenter_name) not like '%pubmed%'
              and dbna.org_abbrev IN (%%PARTITION_KEYS%%)
              and ga.org_abbrev IN (%%PARTITION_KEYS%%)
          union
            select edd.dataset_presenter_display_name AS dataset,
                   ta.gene_source_id as source_id,
                   db.primary_identifier AS ext_id
            from sres.DbRef db, webready.DbRefNaFeature_p dbna,
                 apidbTuning.ExternalDbDatasetPresenter edd,
                 webready.TranscriptAttributes_p ta
            where db.external_database_release_id = edd.external_database_release_id
              and dbna.db_ref_id = db.db_ref_id
              and ta.na_feature_id = dbna.na_feature_id
              and lower(edd.dataset_presenter_name) not like '%nrdb%'
              and lower(edd.dataset_presenter_name) not like '%nafeature_aliases%'
              and edd.dataset_presenter_name not like '%dbxref_simple_gene2HagaiPathway%'
              and lower(edd.dataset_presenter_name) not like '%pubmed%'
              and dbna.org_abbrev IN (%%PARTITION_KEYS%%)
              and ta.org_abbrev IN (%%PARTITION_KEYS%%)
          union
              select replace(substr(ed.name, instr(ed.name, '_', 1, 3)+1), '_geneMapping_RSRC', '') as dataset,
                     ga.source_id, sref.primary_identifier as ext_id
	      from sres.DbRef sref, webready.DbRefNaFeature_p refea, sres.ExternalDatabase ed,
                   sres.ExternalDatabaseRelease edr, webready.GeneAttributes_p ga
	      WHERE sref.external_database_release_id  = edr.external_database_release_id
	      AND ed.external_database_id = edr.external_database_id
	      AND ed.name like '%geneMapping%'
	      AND refea.db_ref_id = sref.db_ref_id
	      AND refea.na_feature_id = ga.na_feature_id
	      AND refea.org_abbrev IN (%%PARTITION_KEYS%%)
	      AND ga.org_abbrev IN (%%PARTITION_KEYS%%)
          union
              select d.name as dataset, ga.source_id, dbr.primary_identifier as ext_id
              from sres.dbref dbr, dots.DbRefNaFeature dbrf,
                   sres.ExternalDatabaseRelease r, sres.ExternalDatabase d,
                   webready.GeneAttributes_p ga
              where dbr.external_database_release_id = r.external_database_release_id
                and r.external_database_id = d.external_database_id
                and dbr.db_ref_id = dbrf.db_ref_id
                and dbrf.na_feature_id = ga.na_feature_id
                and d.name not in ('PUBMED')
                and ga.org_abbrev IN (%%PARTITION_KEYS%%)
          union
              select d.name as dataset, ga.source_id, dbr.primary_identifier as ext_id
              from sres.dbref dbr, dots.DbRefNaFeature dbrf, dots.Transcript t,
                   sres.ExternalDatabaseRelease r, sres.ExternalDatabase d,
                   webready.geneAttributes_p ga
              where dbr.external_database_release_id = r.external_database_release_id
                and r.external_database_id = d.external_database_id
                and dbr.db_ref_id = dbrf.db_ref_id
                and dbrf.na_feature_id = t.na_feature_id
                and t.parent_id = ga.na_feature_id
                and d.name != 'PUBMED'
                and ga.org_abbrev IN (%%PARTITION_KEYS%%)
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="PdbSimilarities">
      <column name="source_id"/>
      <column name="pdb_chain"/>
      <column name="pdb_id"/>
      <column name="taxon"/>
      <column name="pdb_title"/>
      <sql>
        <![CDATA[
          select gene_source_id as source_id,
                pdb_chain, pdb_id, taxon, pdb_title
          from (select distinct ps.pdb_chain, ps.pdb_title, ps.pdb_id, ps.taxon,
                                ta.source_id, ta.gene_source_id
                from webready.PdbSimilarity ps, webready.TranscriptAttributes_p ta
                where ps.source_id = ta.source_id
                  and ta.org_abbrev IN (%%PARTITION_KEYS%%))
          group by gene_source_id, pdb_chain, pdb_id, taxon, pdb_title
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="PubMed">
      <column name="source_id"/>
      <column name="pubmed_id"/>
      <column name="doi"/>
      <column name="title"/>
      <column name="authors"/>
      <sql>
        <![CDATA[
          select distinct gene_source_id as source_id,  'PMID:' || pubmed_id as pubmed_id, doi, title,
                          authors
          from apidbTuning.GenePubmed_p
	  WHERE org_abbrev IN (%%PARTITION_KEYS%%)
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="RodMalPhenotype">
      <column name="source_id"/>
      <column name="rmgmid"/>
      <column name="pubmed_id"/>
      <column name="life_cycle_stage"/>
      <column name="phenotype"/>
      <column name="mutation_description"/>
      <sql>
        <![CDATA[
          with mut
               as (select distinct
                             ga.source_id, pm.source_id as rmgmid, pm.pubmed_id,
                             pm.modification_type as mod_type,
                             pm.mutation_description, ot.name,
                             dbms_lob.substr(pr.phenotype_post_composition, 4000, 1) as phenotype1,
                             dbms_lob.substr(pr.phenotype_post_composition, 4000, 4001) as phenotype2,
                             pm.has_multiple_mutations as multiple,
                             na.na_feature_id as id, pm.phenotype_model_id
                   from apidb.PhenotypeResult pr
                          left outer join sres.OntologyTerm ot
                            on pr.life_cycle_stage_term_id = ot.ontology_term_id,
                        apidb.PhenotypeModel pm, dots.GeneFeature ga,
                        apidb.NaFeaturePhenotypeModel na
                   where pm.phenotype_model_id = pr.phenotype_model_id
                     and na.phenotype_model_id = pm.phenotype_model_id
                     and na.na_feature_id = ga.na_feature_id
                  )
          select m.source_id, m.rmgmid, m.pubmed_id, m.mod_type,
                 m.mutation_description,
                 listagg(m.name, ', ') within group (order by m.name) as life_cycle_stage,
                 concat(to_clob(phenotype1), to_clob(phenotype2)) as phenotype
          from mut m
          group by m.source_id, m.rmgmid, m.pubmed_id, m.mod_type,
                   m.mutation_description, m.phenotype1, m.phenotype2
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="Phenotype">
      <column name="source_id"/>
      <column name="pubmed_id"/>
      <column name="modification_type"/>
      <column name="allele"/>
      <column name="entity"/>
      <column name="quality"/>
      <column name="timing"/>
      <column name="cycle_stage"/>
      <column name="phenotype_post_composition"/>
      <column name="phenotype_comment"/>
      <column name="chebi_annotation_extension"/>
      <sql>
      <![CDATA[
        select gf.source_id, pm.pubmed_id, pm.modification_type, pm.allele,
                  oen.name as entity, opq.name as quality, pr.timing,
                  ols.name as cycle_stage, phenotype_post_composition,
                  phenotype_comment, pr.chebi_annotation_extension
        from dots.GeneFeature gf, apidb.PhenotypeModel pm,
             (  select phenotype_model_id, na_feature_id
                from apidb.PhenotypeModel
              union
                select phenotype_model_id, na_feature_id
                from apidb.NaFeaturePhenotypeModel
             ) pmodel_feature,
             apidb.PhenotypeResult pr
        left join sres.OntologyTerm oen on pr.phenotype_entity_term_id = oen.ontology_term_id 
        left join sres.OntologyTerm opq on pr.phenotype_quality_term_id = opq.ontology_term_id
        left join sres.OntologyTerm ols on pr.life_cycle_stage_term_id = ols.ontology_term_id
        where gf.na_feature_id = pmodel_feature.na_feature_id
        and pm.phenotype_model_id = pmodel_feature.phenotype_model_id
        and pm.phenotype_model_id = pr.phenotype_model_id
       ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="CellularLocalization">
      <column name="source_id"/>
      <column name="note"/>
      <column name="image_type"/>
      <sql>
      <![CDATA[
        select replace(img.note, 'GO term: ', '') as note,
               img.image_type, FeatureIdGeneId.source_id
        from apidb.NaFeatureImage img,
             (  select na_feature_id, source_id
                from dots.GeneFeature
              union
                select t.na_feature_id, g.source_id
                from dots.GeneFeature g, dots.Transcript t
                where t.parent_id = g.na_feature_id) FeatureIdGeneId
        where img.na_feature_id = FeatureIdGeneId.na_feature_id
       ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="GeneModelCharacteristics">
      <column name="source_id"/>
      <column name="characteristic_value"/>
      <sql>
        <![CDATA[
        select ta.gene_source_id as source_id, gmc.string_value as characteristic_value
        from webready.GeneModelCharacteristics_p gmc, webready.TranscriptAttributes_p ta
        where gmc.source_id = ta.source_id
          and string_value not in ('No', 'NA')
          and gmc.org_abbrev IN (%%PARTITION_KEYS%%)
          and ta.org_abbrev IN (%%PARTITION_KEYS%%)
       ]]>
      </sql>
    </sqlQuery>

  </querySet>

</wdkModel>
